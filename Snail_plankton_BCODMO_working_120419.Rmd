---
title: "R Notebook"
output: html_notebook
---
Messy scripts for plankton data to go from Google Sheets to BCO-DMO submittable table

##libraries
Copy and pasted list of packages used from other Snail BCO-DMO submission; will adjust them as necessary
```{r}
package_list<-c("taxize",
                "worrms",
                "tidyr",
                "dplyr",
                "tibble")
#install.packages("taxize") #install packages as necessary
#install.packages("tidyr") # "
#install.packages("dplyr") # "
#install.packages("tibble") # "
for (i in package_list) {
  library(i, character.only = TRUE)
}
```
##Cleaning spreadsheet
###FIRST: Download as .csv, load it
https://docs.google.com/spreadsheets/d/1LY00EGjE-voEqPWtJO3-1vVkgXx5aB0TG3wLFGF6a4c/edit#gid=2017687852
   downloaded so we can work with it offline, and not mess with the original copy

Modifications (NOTE: currently modified in Excel b/c convenience; if issues arise from Excel having trouble with micro as a special character, will try modifying it in a text editor)
  removed rows 1-8; data not relevant to the final submission for this (eg, pump name, vol filtered, etc); as row "size fraction" also identifies the mooring number and site name, the mooring and site rows are unnecessary, and the values in row "size fraction" make adaquate headers for the counts columns- they identify the mooring number, site name, and size fraction
  changed the text "size fraction"  to "group" so it may act as a column header for the far left column

```{r}
setwd("C:/Users/Dale/Desktop")
initial<-read.csv("Mariana_2010_pumps_WORKING-COPY - larval_counts.csv")

initial_cleaning<-initial #create a duplicate of initial called initial_df so that if I screw something up later, I still have the original df untouched

#save various columns as class character
columns<-colnames(initial_cleaning) #make list of column names to check which ones should be characters
char_cols<-columns[1:9] #columns 1 thru 9 contain character inputs; rest are totals
for (i in 1:length(char_cols)){
  initial_cleaning[,i]<-as.character(initial_cleaning[,i])
}
```

###SECOND: Clean and check identifications
Add AphiaIDs from Scientific Name
Check taxon rank (from aphiaID vs manual)
Add phylum (manual verification- correct phylum for each entry)
```{r}
##add column to hold AphiaID
initial_cleaning<-add_column(initial_cleaning,AphiaID="",.after="Group")

##add column to hold taxon rank check
initial_cleaning<-add_column(initial_cleaning,taxonRank_AphiaID_match="",.after="taxonRank")

##finding AphiaID from column scientificName
for (i in 1:length(initial_cleaning$scientificName)) {
  initial_cleaning$AphiaID[i]<-wm_name2id(initial_cleaning$scientificName[i])
}
#make AphiaID numeric, for later calls
initial_cleaning$AphiaID<-as.numeric(initial_cleaning$AphiaID)

#check if AphiaID/scientificName match given taxon
#initial run: lots of FALSEes b/c upper/lowercase mismatch; worms all lowercase; changing taxonRank to all lower
initial_cleaning$taxonRank<-tolower(initial_cleaning$taxonRank)

#for each value in taxonRank, see if equal to the rank of the AphiaID; place this true/false as value for taxonRank_AphiaID_match column
for (i in 1:length(initial_cleaning$scientificName)) {
  initial_cleaning$taxonRank_AphiaID_match[i]<-isTRUE(initial_cleaning$taxonRank[i] == as.character(tax_rank(initial_cleaning$AphiaID[i], db="worms")))
}

#get phylum from AphiaID, for manual validation
initial_cleaning<-add_column(initial_cleaning,Phylum="",.before="scientificName")

for (i in 1:length(initial_cleaning$AphiaID)){
  tree<-classification(initial_cleaning$AphiaID[i], db='worms') #get taxonomic stuff from WoRMS based on AphiaID
  df_tree<-as.data.frame(tree[[1]]) #take just the name/rank/id portion, as a df, from classification() output
  if (length(df_tree$name[(which(df_tree$rank=="Phylum"))])==0) { #some are only to Animalia, and so have no value for Phylum in the output from classification(); put "NA" here. This if/else helps prevent the for loop from throwing an error and stopping when it encounters a classification() output that has no phylum
    initial_cleaning$Phylum[i]<-"NA"
    #paste(c("error row:",i," AphiaID:",initial_cleaning$AphiaID[i]), sep="")
  }
  else
    initial_cleaning$Phylum[i]<-df_tree$name[which(df_tree$rank == "Phylum")] #set name of the phylum to initial_cleaning$Phylum value
}

```

###THIRD: Add additional identification data
Generate and insert LSID from AphiaID
```{r}
#using LSID as scientificNameID
#LSID is just a consistent 'preamble' URI, plus AphiaID
for (i in 1:length(initial_cleaning$AphiaID)) {
  initial_cleaning$scientificNameID[i]<-paste("urn:lsid:marinespecies.org:taxname:",initial_cleaning$AphiaID[i],sep="")
}
```